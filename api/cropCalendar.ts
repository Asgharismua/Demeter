import type { CropInfo } from "@shared/schema";

export const uaeCropCalendar: CropInfo[] = [
  {
    id: "tomato",
    nameEn: "Tomato",
    nameAr: "طماطم",
    plantingMonths: [9, 10, 11],
    harvestMonths: [12, 1, 2, 3],
    category: "Vegetables",
    descriptionEn: "Best grown in cooler months. Requires regular watering and support structures.",
    descriptionAr: "يُزرع بشكل أفضل في الأشهر الباردة. يحتاج إلى الري المنتظم وهياكل الدعم.",
  },
  {
    id: "cucumber",
    nameEn: "Cucumber",
    nameAr: "خيار",
    plantingMonths: [9, 10, 11, 2, 3],
    harvestMonths: [11, 12, 1, 4, 5],
    category: "Vegetables",
    descriptionEn: "Thrives in UAE's warm climate. Needs frequent watering and well-drained soil.",
    descriptionAr: "ينمو بشكل جيد في مناخ الإمارات الدافئ. يحتاج إلى الري المتكرر والتربة جيدة التصريف.",
  },
  {
    id: "eggplant",
    nameEn: "Eggplant",
    nameAr: "باذنجان",
    plantingMonths: [9, 10, 11],
    harvestMonths: [12, 1, 2, 3, 4],
    category: "Vegetables",
    descriptionEn: "Heat-tolerant crop. Plant in autumn for best results in UAE conditions.",
    descriptionAr: "محصول يتحمل الحرارة. يُزرع في الخريف للحصول على أفضل النتائج في ظروف الإمارات.",
  },
  {
    id: "lettuce",
    nameEn: "Lettuce",
    nameAr: "خس",
    plantingMonths: [10, 11, 12, 1],
    harvestMonths: [12, 1, 2, 3],
    category: "Leafy Greens",
    descriptionEn: "Grows well in cooler months. Requires shade during hot periods and consistent moisture.",
    descriptionAr: "ينمو جيداً في الأشهر الباردة. يحتاج إلى الظل خلال الفترات الحارة والرطوبة المستمرة.",
  },
  {
    id: "spinach",
    nameEn: "Spinach",
    nameAr: "سبانخ",
    plantingMonths: [10, 11, 12, 1, 2],
    harvestMonths: [12, 1, 2, 3, 4],
    category: "Leafy Greens",
    descriptionEn: "Ideal winter crop. Fast-growing and nutrient-rich.",
    descriptionAr: "محصول شتوي مثالي. سريع النمو وغني بالمغذيات.",
  },
  {
    id: "carrot",
    nameEn: "Carrot",
    nameAr: "جزر",
    plantingMonths: [10, 11, 12, 1],
    harvestMonths: [1, 2, 3, 4],
    category: "Root Vegetables",
    descriptionEn: "Plant in well-drained sandy soil. Avoid heavy clay soils.",
    descriptionAr: "يُزرع في تربة رملية جيدة التصريف. تجنب التربة الطينية الثقيلة.",
  },
  {
    id: "radish",
    nameEn: "Radish",
    nameAr: "فجل",
    plantingMonths: [10, 11, 12, 1, 2],
    harvestMonths: [11, 12, 1, 2, 3],
    category: "Root Vegetables",
    descriptionEn: "Fast-growing crop, ready in 3-4 weeks. Great for beginners.",
    descriptionAr: "محصول سريع النمو، يكون جاهزاً في 3-4 أسابيع. رائع للمبتدئين.",
  },
  {
    id: "pepper",
    nameEn: "Bell Pepper",
    nameAr: "فلفل حلو",
    plantingMonths: [9, 10, 11, 2],
    harvestMonths: [12, 1, 2, 3, 4, 5],
    category: "Vegetables",
    descriptionEn: "Grows well in UAE climate. Requires full sun and regular watering.",
    descriptionAr: "ينمو جيداً في مناخ الإمارات. يحتاج إلى شمس كاملة وري منتظم.",
  },
  {
    id: "zucchini",
    nameEn: "Zucchini",
    nameAr: "كوسة",
    plantingMonths: [9, 10, 11, 2, 3],
    harvestMonths: [11, 12, 1, 4, 5],
    category: "Vegetables",
    descriptionEn: "Productive crop in UAE. Plant in cooler months for better yield.",
    descriptionAr: "محصول منتج في الإمارات. يُزرع في الأشهر الباردة للحصول على إنتاج أفضل.",
  },
  {
    id: "okra",
    nameEn: "Okra",
    nameAr: "بامية",
    plantingMonths: [3, 4, 5, 6],
    harvestMonths: [5, 6, 7, 8, 9],
    category: "Vegetables",
    descriptionEn: "Heat-loving crop. Perfect for UAE's hot summer months.",
    descriptionAr: "محصول محب للحرارة. مثالي لأشهر الصيف الحارة في الإمارات.",
  },
  {
    id: "date-palm",
    nameEn: "Date Palm",
    nameAr: "نخيل التمر",
    plantingMonths: [2, 3, 4],
    harvestMonths: [8, 9, 10],
    category: "Fruits",
    descriptionEn: "Traditional UAE crop. Extremely heat-tolerant and drought-resistant.",
    descriptionAr: "محصول إماراتي تقليدي. يتحمل الحرارة الشديدة ومقاوم للجفاف.",
  },
  {
    id: "mango",
    nameEn: "Mango",
    nameAr: "مانجو",
    plantingMonths: [3, 4, 5],
    harvestMonths: [6, 7, 8],
    category: "Fruits",
    descriptionEn: "Grows well in UAE's hot climate. Requires deep watering.",
    descriptionAr: "ينمو جيداً في مناخ الإمارات الحار. يحتاج إلى ري عميق.",
  },
  {
    id: "strawberry",
    nameEn: "Strawberry",
    nameAr: "فراولة",
    plantingMonths: [10, 11, 12],
    harvestMonths: [1, 2, 3, 4],
    category: "Fruits",
    descriptionEn: "Winter crop in UAE. Requires cool temperatures and consistent watering.",
    descriptionAr: "محصول شتوي في الإمارات. يحتاج إلى درجات حرارة باردة وري مستمر.",
  },
  {
    id: "watermelon",
    nameEn: "Watermelon",
    nameAr: "بطيخ",
    plantingMonths: [2, 3, 4],
    harvestMonths: [5, 6, 7],
    category: "Fruits",
    descriptionEn: "Summer crop. Needs plenty of space and water.",
    descriptionAr: "محصول صيفي. يحتاج إلى مساحة كبيرة والكثير من الماء.",
  },
  {
    id: "mint",
    nameEn: "Mint",
    nameAr: "نعناع",
    plantingMonths: [9, 10, 11, 2, 3],
    harvestMonths: [11, 12, 1, 2, 3, 4, 5],
    category: "Herbs",
    descriptionEn: "Easy to grow. Prefers partial shade and moist soil.",
    descriptionAr: "سهل الزراعة. يفضل الظل الجزئي والتربة الرطبة.",
  },
  {
    id: "coriander",
    nameEn: "Coriander",
    nameAr: "كزبرة",
    plantingMonths: [10, 11, 12, 1, 2],
    harvestMonths: [12, 1, 2, 3, 4],
    category: "Herbs",
    descriptionEn: "Cool season herb. Quick growing and aromatic.",
    descriptionAr: "عشبة للموسم البارد. سريعة النمو وعطرية.",
  },
  {
    id: "basil",
    nameEn: "Basil",
    nameAr: "ريحان",
    plantingMonths: [3, 4, 5, 9, 10],
    harvestMonths: [5, 6, 7, 11, 12],
    category: "Herbs",
    descriptionEn: "Warm weather herb. Requires full sun and regular harvesting.",
    descriptionAr: "عشبة الطقس الدافئ. تحتاج إلى شمس كاملة وحصاد منتظم.",
  },
  {
    id: "parsley",
    nameEn: "Parsley",
    nameAr: "بقدونس",
    plantingMonths: [10, 11, 12, 1, 2],
    harvestMonths: [12, 1, 2, 3, 4, 5],
    category: "Herbs",
    descriptionEn: "Hardy herb for cooler months. Rich in vitamins.",
    descriptionAr: "عشبة قوية للأشهر الباردة. غنية بالفيتامينات.",
  },
];

export function getCropsByMonth(month: number): CropInfo[] {
  return uaeCropCalendar.filter(crop => 
    crop.plantingMonths.includes(month)
  );
}

export function getCurrentSeasonCrops(): CropInfo[] {
  const currentMonth = new Date().getMonth() + 1;
  return getCropsByMonth(currentMonth);
}

export function getCropById(id: string): CropInfo | undefined {
  return uaeCropCalendar.find(crop => crop.id === id);
}

import { drizzle } from "drizzle-orm/neon-http";
import { neon } from "@neondatabase/serverless";
import * as schema from "@shared/schema";

if (!process.env.DATABASE_URL) {
  throw new Error("DATABASE_URL must be set");
}

const sql = neon(process.env.DATABASE_URL);
export const db = drizzle(sql, { schema });

import { GoogleGenAI } from "@google/genai";

// DON'T DELETE THIS COMMENT
// Follow these instructions when using this blueprint:
// - Note that the newest Gemini model series is "gemini-2.5-flash" or gemini-2.5-pro"
//   - do not change this unless explicitly requested by the user

// This API key is from Gemini Developer API Key, not vertex AI API Key
const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || "" });

interface FarmingAdviceParams {
  query: string;
  language: "en" | "ar";
  temperature: number;
  humidity: number;
  rainfall: number;
  windSpeed: number;
  location: string;
}

export async function generateFarmingAdvice(params: FarmingAdviceParams): Promise<string> {
  const { query, language, temperature, humidity, rainfall, windSpeed, location } = params;

  const systemPrompt = language === "ar"
    ? `أنت مستشار زراعي خبير متخصص في الزراعة في دولة الإمارات العربية المتحدة والمناطق الصحراوية الحارة.

لديك معرفة عميقة بـ:
- المحاصيل المناسبة للمناخ الحار والجاف في الإمارات
- أنظمة الري الحديثة والموفرة للمياه (التنقيط، الرش، الهيدروبونيك)
- إدارة التربة الرملية والملحية
- الزراعة المحمية (البيوت المحمية) لمواجهة الحرارة الشديدة
- مواعيد الزراعة المثالية في الإمارات
- الآفات والأمراض الشائعة في المنطقة وطرق مكافحتها

قدم نصائح تفصيلية وعملية باللغة العربية تشمل:
1. تحليل الوضع الحالي بناءً على الطقس والموقع
2. توصيات محددة وقابلة للتطبيق فوراً
3. نصائح للري والتسميد إن كانت ذات صلة
4. تحذيرات من المخاطر المحتملة
5. نصائح للحصول على أفضل النتائج

استخدم لغة عربية واضحة ومباشرة. اجعل الإجابة شاملة (4-8 فقرات) مع تفاصيل عملية.`
    : `You are an expert agricultural advisor specializing in UAE farming and hot desert agriculture.

You have deep knowledge of:
- Crops suitable for UAE's hot and arid climate
- Modern water-efficient irrigation systems (drip, sprinkler, hydroponics)
- Sandy and saline soil management
- Protected agriculture (greenhouses) for extreme heat
- Optimal planting schedules in the UAE
- Common pests and diseases in the region and their control

Provide detailed, practical advice in English that includes:
1. Analysis of the current situation based on weather and location
2. Specific, immediately actionable recommendations
3. Irrigation and fertilization advice if relevant
4. Warnings about potential risks
5. Tips for best results

Use clear, direct language. Make your response comprehensive (4-8 paragraphs) with practical details.`;

  const weatherContext = language === "ar"
    ? `الظروف الجوية الحالية في ${location}:
- درجة الحرارة: ${Math.round(temperature)}°C
- الرطوبة: ${Math.round(humidity)}%
- هطول الأمطار: ${rainfall.toFixed(1)} ملم
- سرعة الرياح: ${Math.round(windSpeed)} كم/ساعة`
    : `Current weather conditions in ${location}:
- Temperature: ${Math.round(temperature)}°C
- Humidity: ${Math.round(humidity)}%
- Rainfall: ${rainfall.toFixed(1)} mm
- Wind Speed: ${Math.round(windSpeed)} km/h`;

  const userPrompt = language === "ar"
    ? `${weatherContext}

سؤال المزارع: ${query}

قدم نصيحة زراعية تفصيلية وشاملة (4-8 فقرات) خاصة بـ${location} مع مراعاة:
- الظروف الجوية الحالية المذكورة أعلاه
- المناخ الصحراوي الحار للإمارات
- التحديات الخاصة بالمنطقة (نقص المياه، التربة الرملية، الحرارة العالية)
- أفضل الممارسات للزراعة في هذه البيئة

كن مفصلاً وعملياً. قدم خطوات محددة وقابلة للتطبيق.`
    : `${weatherContext}

Farmer's question: ${query}

Provide detailed, comprehensive farming advice (4-8 paragraphs) specific to ${location} considering:
- The current weather conditions stated above
- UAE's hot desert climate
- Region-specific challenges (water scarcity, sandy soil, extreme heat)
- Best practices for farming in this environment

Be detailed and practical. Provide specific, actionable steps.`;

  try {
    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      config: {
        systemInstruction: systemPrompt,
      },
      contents: [
        {
          role: "user",
          parts: [{ text: userPrompt }],
        },
      ],
    });

    return response.text || (language === "ar" ? "عذراً، لم أتمكن من توليد نصيحة. حاول مرة أخرى." : "Sorry, I couldn't generate advice. Please try again.");
  } catch (error) {
    console.error("Gemini API error:", error);
    throw new Error(language === "ar" ? "خطأ في توليد النصيحة" : "Failed to generate advice");
  }
}

import express, { type Request, Response, NextFunction } from "express";
import { registerRoutes } from "./routes";
import { setupVite, serveStatic, log } from "./vite";

const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: false }));

app.use((req, res, next) => {
  const start = Date.now();
  const path = req.path;
  let capturedJsonResponse: Record<string, any> | undefined = undefined;

  const originalResJson = res.json;
  res.json = function (bodyJson, ...args) {
    capturedJsonResponse = bodyJson;
    return originalResJson.apply(res, [bodyJson, ...args]);
  };

  res.on("finish", () => {
    const duration = Date.now() - start;
    if (path.startsWith("/api")) {
      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;
      if (capturedJsonResponse) {
        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;
      }

      if (logLine.length > 80) {
        logLine = logLine.slice(0, 79) + "…";
      }

      log(logLine);
    }
  });

  next();
});

(async () => {
  const server = await registerRoutes(app);

  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {
    const status = err.status || err.statusCode || 500;
    const message = err.message || "Internal Server Error";

    res.status(status).json({ message });
    throw err;
  });

  // importantly only setup vite in development and after
  // setting up all the other routes so the catch-all route
  // doesn't interfere with the other routes
  if (app.get("env") === "development") {
    await setupVite(app, server);
  } else {
    serveStatic(app);
  }

  // ALWAYS serve the app on the port specified in the environment variable PORT
  // Other ports are firewalled. Default to 5000 if not specified.
  // this serves both the API and the client.
  // It is the only port that is not firewalled.
  const port = parseInt(process.env.PORT || '5000', 10);
  server.listen({
    port,
    host: "0.0.0.0",
    reusePort: true,
  }, () => {
    log(`serving on port ${port}`);
  });
})();

import type { Express } from "express";
import { createServer, type Server } from "http";
import { fetchWeatherData, fetchWeatherForecast } from "./weather";
import { generateFarmingAdvice } from "./gemini";
import { adviceRequestSchema } from "@shared/schema";
import { storage } from "./storage";
import { uaeCropCalendar, getCropsByMonth, getCurrentSeasonCrops } from "./cropCalendar";

export async function registerRoutes(app: Express): Promise<Server> {
  // Weather endpoint - fetch current weather data
  app.get("/api/weather", async (req, res) => {
    try {
      const lat = parseFloat(req.query.lat as string);
      const lon = parseFloat(req.query.lon as string);

      if (isNaN(lat) || isNaN(lon)) {
        return res.status(400).json({ 
          error: "Invalid latitude or longitude" 
        });
      }

      const weatherData = await fetchWeatherData(lat, lon);
      res.json(weatherData);
    } catch (error) {
      console.error("Weather endpoint error:", error);
      res.status(500).json({ 
        error: error instanceof Error ? error.message : "Failed to fetch weather data" 
      });
    }
  });

  // Weather forecast endpoint - fetch 7-day forecast
  app.get("/api/forecast", async (req, res) => {
    try {
      const lat = parseFloat(req.query.lat as string);
      const lon = parseFloat(req.query.lon as string);

      if (isNaN(lat) || isNaN(lon)) {
        return res.status(400).json({ 
          error: "Invalid latitude or longitude" 
        });
      }

      const forecast = await fetchWeatherForecast(lat, lon);
      res.json(forecast);
    } catch (error) {
      console.error("Forecast endpoint error:", error);
      res.status(500).json({ 
        error: error instanceof Error ? error.message : "Failed to fetch weather forecast" 
      });
    }
  });

  // Crop calendar endpoint - get all crops
  app.get("/api/crops", async (req, res) => {
    try {
      const month = req.query.month ? parseInt(req.query.month as string) : undefined;
      
      if (month !== undefined && (isNaN(month) || month < 1 || month > 12)) {
        return res.status(400).json({ 
          error: "Invalid month. Must be between 1 and 12" 
        });
      }

      const crops = month ? getCropsByMonth(month) : uaeCropCalendar;
      res.json(crops);
    } catch (error) {
      console.error("Crops endpoint error:", error);
      res.status(500).json({ 
        error: error instanceof Error ? error.message : "Failed to fetch crop data" 
      });
    }
  });

  // Current season crops endpoint
  app.get("/api/crops/current", async (req, res) => {
    try {
      const crops = getCurrentSeasonCrops();
      res.json(crops);
    } catch (error) {
      console.error("Current crops endpoint error:", error);
      res.status(500).json({ 
        error: error instanceof Error ? error.message : "Failed to fetch current season crops" 
      });
    }
  });

  // Advice endpoint - generate farming advice using Gemini AI
  app.post("/api/advice", async (req, res) => {
    try {
      // Validate request body
      const validation = adviceRequestSchema.safeParse(req.body);
      
      if (!validation.success) {
        return res.status(400).json({ 
          error: "Invalid request data",
          details: validation.error.issues,
        });
      }

      const { query, language, weatherData } = validation.data;

      // Generate farming advice
      const advice = await generateFarmingAdvice({
        query,
        language,
        temperature: weatherData.temperature,
        humidity: weatherData.humidity,
        rainfall: weatherData.rainfall,
        windSpeed: weatherData.windSpeed,
        location: weatherData.locationName || "your location",
      });

      // Create weather summary
      const weatherSummary = language === "ar"
        ? `${Math.round(weatherData.temperature)}°C، رطوبة ${Math.round(weatherData.humidity)}%`
        : `${Math.round(weatherData.temperature)}°C, ${Math.round(weatherData.humidity)}% humidity`;

      const response = {
        advice,
        language,
        timestamp: new Date().toISOString(),
        weatherSummary,
      };

      // Save to history
      await storage.saveAdviceHistory({
        query,
        advice,
        language,
        temperature: weatherData.temperature,
        humidity: weatherData.humidity,
        rainfall: weatherData.rainfall,
        windSpeed: weatherData.windSpeed,
        locationName: weatherData.locationName,
        latitude: weatherData.latitude,
        longitude: weatherData.longitude,
      });

      res.json(response);
    } catch (error) {
      console.error("Advice endpoint error:", error);
      res.status(500).json({ 
        error: error instanceof Error ? error.message : "Failed to generate advice" 
      });
    }
  });

  // Advice history endpoint - get past advice
  app.get("/api/advice/history", async (req, res) => {
    try {
      const limit = req.query.limit ? parseInt(req.query.limit as string) : 20;
      
      if (isNaN(limit) || limit < 1 || limit > 100) {
        return res.status(400).json({ 
          error: "Invalid limit. Must be between 1 and 100" 
        });
      }

      const history = await storage.getAdviceHistory(limit);
      res.json(history);
    } catch (error) {
      console.error("History endpoint error:", error);
      res.status(500).json({ 
        error: error instanceof Error ? error.message : "Failed to fetch advice history" 
      });
    }
  });

  const httpServer = createServer(app);

  return httpServer;
}

import { type InsertAdviceHistory, type AdviceHistoryRecord, adviceHistory } from "@shared/schema";
import { db } from "./db";
import { desc } from "drizzle-orm";

export interface IStorage {
  saveAdviceHistory(record: InsertAdviceHistory): Promise<AdviceHistoryRecord>;
  getAdviceHistory(limit?: number): Promise<AdviceHistoryRecord[]>;
}

export class DbStorage implements IStorage {
  async saveAdviceHistory(record: InsertAdviceHistory): Promise<AdviceHistoryRecord> {
    const [result] = await db.insert(adviceHistory).values(record).returning();
    return result;
  }

  async getAdviceHistory(limit: number = 20): Promise<AdviceHistoryRecord[]> {
    return await db
      .select()
      .from(adviceHistory)
      .orderBy(desc(adviceHistory.timestamp))
      .limit(limit);
  }
}

export const storage = new DbStorage();

import express, { type Express } from "express";
import fs from "fs";
import path from "path";
import { createServer as createViteServer, createLogger } from "vite";
import { type Server } from "http";
import viteConfig from "../vite.config";
import { nanoid } from "nanoid";

const viteLogger = createLogger();

export function log(message: string, source = "express") {
  const formattedTime = new Date().toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
  });

  console.log(`${formattedTime} [${source}] ${message}`);
}

export async function setupVite(app: Express, server: Server) {
  const serverOptions = {
    middlewareMode: true,
    hmr: { server },
    allowedHosts: true as const,
  };

  const vite = await createViteServer({
    ...viteConfig,
    configFile: false,
    customLogger: {
      ...viteLogger,
      error: (msg, options) => {
        viteLogger.error(msg, options);
        process.exit(1);
      },
    },
    server: serverOptions,
    appType: "custom",
  });

  app.use(vite.middlewares);
  app.use("*", async (req, res, next) => {
    const url = req.originalUrl;

    try {
      const clientTemplate = path.resolve(
        import.meta.dirname,
        "..",
        "client",
        "index.html",
      );

      // always reload the index.html file from disk incase it changes
      let template = await fs.promises.readFile(clientTemplate, "utf-8");
      template = template.replace(
        `src="/src/main.tsx"`,
        `src="/src/main.tsx?v=${nanoid()}"`,
      );
      const page = await vite.transformIndexHtml(url, template);
      res.status(200).set({ "Content-Type": "text/html" }).end(page);
    } catch (e) {
      vite.ssrFixStacktrace(e as Error);
      next(e);
    }
  });
}

export function serveStatic(app: Express) {
  const distPath = path.resolve(import.meta.dirname, "public");

  if (!fs.existsSync(distPath)) {
    throw new Error(
      `Could not find the build directory: ${distPath}, make sure to build the client first`,
    );
  }

  app.use(express.static(distPath));

  // fall through to index.html if the file doesn't exist
  app.use("*", (_req, res) => {
    res.sendFile(path.resolve(distPath, "index.html"));
  });
}

interface OpenMeteoResponse {
  current: {
    temperature_2m: number;
    relative_humidity_2m: number;
    precipitation: number;
    wind_speed_10m: number;
    weather_code: number;
  };
}

interface OpenMeteoForecastResponse {
  daily: {
    time: string[];
    temperature_2m_max: number[];
    temperature_2m_min: number[];
    relative_humidity_2m_mean: number[];
    precipitation_sum: number[];
    wind_speed_10m_max: number[];
    weather_code: number[];
  };
}

interface WeatherData {
  temperature: number;
  humidity: number;
  rainfall: number;
  windSpeed: number;
  weatherCode: number;
  latitude: number;
  longitude: number;
  locationName?: string;
}

interface WeatherForecast {
  location: string;
  forecast: Array<{
    date: string;
    maxTemp: number;
    minTemp: number;
    humidity: number;
    rainfall: number;
    windSpeed: number;
    weatherCode: number;
  }>;
}

export async function fetchWeatherData(latitude: number, longitude: number): Promise<WeatherData> {
  try {
    // Fetch weather data from Open-Meteo API
    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,weather_code&timezone=auto`;
    
    const weatherResponse = await fetch(weatherUrl);
    if (!weatherResponse.ok) {
      throw new Error(`Weather API error: ${weatherResponse.statusText}`);
    }
    
    const weatherData: OpenMeteoResponse = await weatherResponse.json();

    // Fetch location name using reverse geocoding
    let locationName = "Your Location";
    try {
      const geocodeUrl = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${latitude}&longitude=${longitude}&count=1`;
      const geocodeResponse = await fetch(geocodeUrl);
      
      if (geocodeResponse.ok) {
        const geocodeData = await geocodeResponse.json();
        if (geocodeData.results && geocodeData.results[0]) {
          const result = geocodeData.results[0];
          locationName = result.name || result.admin1 || result.country || "Your Location";
        }
      }
    } catch (error) {
      console.error("Geocoding error:", error);
    }

    return {
      temperature: weatherData.current.temperature_2m,
      humidity: weatherData.current.relative_humidity_2m,
      rainfall: weatherData.current.precipitation,
      windSpeed: weatherData.current.wind_speed_10m,
      weatherCode: weatherData.current.weather_code,
      latitude,
      longitude,
      locationName,
    };
  } catch (error) {
    console.error("Error fetching weather data:", error);
    throw new Error("Failed to fetch weather data");
  }
}

export async function fetchWeatherForecast(latitude: number, longitude: number): Promise<WeatherForecast> {
  try {
    const forecastUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=temperature_2m_max,temperature_2m_min,relative_humidity_2m_mean,precipitation_sum,wind_speed_10m_max,weather_code&timezone=auto&forecast_days=7`;
    
    const forecastResponse = await fetch(forecastUrl);
    if (!forecastResponse.ok) {
      throw new Error(`Forecast API error: ${forecastResponse.statusText}`);
    }
    
    const forecastData: OpenMeteoForecastResponse = await forecastResponse.json();

    let locationName = "Your Location";
    try {
      const geocodeUrl = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${latitude}&longitude=${longitude}&count=1`;
      const geocodeResponse = await fetch(geocodeUrl);
      
      if (geocodeResponse.ok) {
        const geocodeData = await geocodeResponse.json();
        if (geocodeData.results && geocodeData.results[0]) {
          const result = geocodeData.results[0];
          locationName = result.name || result.admin1 || result.country || "Your Location";
        }
      }
    } catch (error) {
      console.error("Geocoding error:", error);
    }

    const forecast = forecastData.daily.time.map((date, index) => ({
      date,
      maxTemp: forecastData.daily.temperature_2m_max[index],
      minTemp: forecastData.daily.temperature_2m_min[index],
      humidity: forecastData.daily.relative_humidity_2m_mean[index],
      rainfall: forecastData.daily.precipitation_sum[index],
      windSpeed: forecastData.daily.wind_speed_10m_max[index],
      weatherCode: forecastData.daily.weather_code[index],
    }));

    return {
      location: locationName,
      forecast,
    };
  } catch (error) {
    console.error("Error fetching weather forecast:", error);
    throw new Error("Failed to fetch weather forecast");
  }
}
